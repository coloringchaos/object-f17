---
layout: post
title: Lab 6
permalink: /lab-6/
---

In this lab, you will use serial communication to send at least two sensor values from Arduino to [P5JS](https://p5js.org). Using P5, you must create an interactive, visual output from the incoming sensor data.

<span class="underlined">**Lab Objectives:**</span>

+ Explore serial communication between Arduino and P5
+ Learn how to appropriately format data to send between devices
+ Build an interface using P5

<span class="underlined">**Lab 6 Resources:**</span>

+ [Serial Output from Arduino to P5 as Binary](https://vimeo.com/237203208)
+ [Serial Output as ASCII](https://vimeo.com/239025399)

*Hint: use these video resources!!!*

<br>

<span class="underlined">**The Arduino Side:**</span>

Build a circuit with two analog sensors. Print the values to the Serial Monitor in Arduino to ensure that you are getting good values.

You will be sending these values serially to Processing, and since you are sending multiple values, you should send your data as an ASCII string and parse the data in P5. Pay attention to how you format your data in the Serial Monitor before moving to P5.

<span class="underlined">**The P5 Side:**</span>

Connect to the Serial Port that your Arduino is sending data to, read and parse the values into P5.Then, design an interface using P5 - a visual output of data from your Arduino circuit. Simple is okay, just focus on building something responsive and intuitive.

**Some notes on this setup:**

In order for Arduino to talk to P5, you will need to install the [p5.seriacontrol](https://github.com/vanevery/p5.serialcontrol/releases) App. This little app makes our life easier by establishing communication between the serial port and the web browser. You can also run p5.serialserver in the commandline, there are notes about how to do that [here](https://itp.nyu.edu/physcomp/labs/labs-serial-communication/lab-serial-input-to-the-p5-js-ide/).

Once you've downloaded the p5.serialcontrol App, you're ready to make a sketch. I suggest using the [p5 web editor](http://alpha.editor.p5js.org/). You will also need to download this file: [p5.serialport.js](https://raw.githubusercontent.com/vanevery/p5.serialport/master/lib/p5.serialport.js). Add it to your sketch by clicking the file navigation arrow on the left of the screen, then click the down arrow to add files. Choose the downloaded p5.serialport.js file and upload it to your sketch.

![p5 add file](../img/p5-add-file.png "Add file to P5")

Once you've added this file, you will need to write a link to include it in your index page. In the `<head>` of the index page, after the script tags that link to the p5 library, add this line:

`<script language="javascript" type="text/javascript" src="p5.serialport.js"></script>`

Save index.html. Now you’re ready to edit the sketch.

First, you need to find out what port you are connected to. Use the following code in *sketch.js* to determine what serial ports are available.

<pre>
var serial; // variable to hold an instance of the serialport library

function setup() {
 serial = new p5.SerialPort(); // make a new instance of the serialport library
 serial.on('list', printList); // set a callback function for the serialport list event

 serial.list(); // list the serial ports
}

// get the list of ports:
function printList(portList) {
 // portList is an array of serial port names
 for (var i = 0; i < portList.length; i++) {
 // Display the list the console:
 print(i + " " + portList[i]);
 }
}
</pre>

**Serial Events**

P5 is built on JavaScript, a language that relies heavily on **events** and **callback functions**. An **event** is generated by the operating system when something significant happens, like a serial port opening, or new data arriving in the port. In your sketch, you write a **callback function** to respond to that event. The serialport library uses events and callback functions as well. It can listen for the following serialport events:

+ list – the program asks for a list of ports.
+ connected – when the sketch connects to a webSocket-to-serial server
+ open – a serial port is opened
+ close – a serial port is closed
+ data – new data arrives in a serial port
+ error – something goes wrong.

Here's the code for this:

<pre>
var serial;          // variable to hold an instance of the serialport library
var portName = 'YOUR PORT';  // fill in your serial port name here

function setup() {
  serial = new p5.SerialPort();       // make a new instance of the serialport library
  serial.on('list', printList);  // set a callback function for the serialport list event
  serial.on('connected', serverConnected); // callback for connecting to the server
  serial.on('open', portOpen);        // callback for the port opening
  serial.on('data', serialEvent);     // callback for when new data arrives
  serial.on('error', serialError);    // callback for errors
  serial.on('close', portClose);      // callback for the port closing

  serial.list();                      // list the serial ports
  serial.open(portName);              // open a serial port
}
</pre>

Then, below the draw function, we need to include our callback functions.

<pre>
function serverConnected() {
  println('connected to server.');
}

function portOpen() {
  println('the serial port opened.')
}

function serialEvent() {

}

function serialError(err) {
  println('Something went wrong with the serial port. ' + err);
}

function portClose() {
  println('The serial port closed.');
}

</pre>
<hr>

***Lab 8 is due before class on Tuesday October 31st***

Your blog response should include a *clear* video of what you made (show both the Arduino and P5 side), a schematic diagram, a brief written description of what you made, and all of your code embedded with GitHub Gist. Submit a link to your blog post on D2L.
